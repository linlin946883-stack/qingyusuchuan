<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试用户信息获取</title>
    <script src="./js/config.js"></script>
    <script src="./js/common.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .info-box {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>用户信息获取测试</h1>
    
    <div class="info-box">
        <h3>步骤 1: 检查配置</h3>
        <p>API 基础URL: <strong id="apiUrl"></strong></p>
        <p>是否有 Token: <strong id="hasToken"></strong></p>
        <p>Token 值: <strong id="tokenValue" style="word-break: break-all;"></strong></p>
    </div>
    
    <div class="info-box">
        <h3>步骤 2: 测试获取用户信息</h3>
        <button onclick="testGetUserInfo()">获取用户信息</button>
        <button onclick="testWechatAuth()">微信授权登录</button>
        <button onclick="clearToken()">清除 Token</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        // 显示配置信息
        document.getElementById('apiUrl').textContent = window.API_BASE_URL || '未配置';
        document.getElementById('hasToken').textContent = hasToken() ? '是' : '否';
        document.getElementById('tokenValue').textContent = getToken() || '无';
        
        // 检查URL中的token
        window.addEventListener('DOMContentLoaded', () => {
            getTokenFromUrl();
            // 刷新显示
            document.getElementById('hasToken').textContent = hasToken() ? '是' : '否';
            document.getElementById('tokenValue').textContent = getToken() || '无';
        });
        
        async function testGetUserInfo() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info-box">正在获取用户信息...</div>';
            
            try {
                const token = getToken();
                if (!token) {
                    resultDiv.innerHTML = '<div class="info-box error">错误: 未找到 Token，请先进行微信授权</div>';
                    return;
                }
                
                console.log('发送请求到:', window.API_BASE_URL + '/users/');
                console.log('请求头:', getAuthHeaders());
                
                const response = await fetch(window.API_BASE_URL + '/users/', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                console.log('响应状态:', response.status);
                
                const result = await response.json();
                console.log('响应数据:', result);
                
                if (result.code === 0 && result.data) {
                    const user = result.data;
                    resultDiv.innerHTML = `
                        <div class="info-box success">
                            <h3>✅ 获取成功</h3>
                            <p><strong>ID:</strong> ${user.id}</p>
                            <p><strong>OpenID:</strong> ${user.openid}</p>
                            <p><strong>昵称:</strong> ${user.nickname}</p>
                            <p><strong>头像:</strong> ${user.avatar || '无'}</p>
                            ${user.avatar ? '<img src="' + user.avatar + '" style="width:100px;height:100px;border-radius:50%;">' : ''}
                            <p><strong>余额:</strong> ¥${user.balance || 0}</p>
                        </div>
                        <div class="info-box">
                            <h4>完整数据:</h4>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="info-box error">
                            <h3>❌ 获取失败</h3>
                            <p>错误码: ${result.code}</p>
                            <p>错误信息: ${result.message}</p>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('请求错误:', error);
                resultDiv.innerHTML = `
                    <div class="info-box error">
                        <h3>❌ 请求异常</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        function testWechatAuth() {
            if (!isWeChatBrowser()) {
                alert('请在微信中打开此页面');
                return;
            }
            wechatAuth('snsapi_userinfo', '/test-user-info.html');
        }
        
        function clearToken() {
            removeToken();
            document.getElementById('hasToken').textContent = '否';
            document.getElementById('tokenValue').textContent = '无';
            document.getElementById('result').innerHTML = '<div class="info-box">Token 已清除</div>';
        }
    </script>
</body>
</html>
