<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - 轻羽速传</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
    <div class="admin-container">
        <!-- 侧边栏 -->
        <div class="admin-sidebar">
            <div class="admin-logo">
                <h2>📊 管理后台</h2>
            </div>
            <nav class="admin-nav">
                <div class="nav-item active" onclick="switchPage('dashboard')">
                    <span class="nav-icon">📈</span>
                    <span class="nav-label">数据概览</span>
                </div>
                <div class="nav-item" onclick="switchPage('orders')">
                    <span class="nav-icon">📦</span>
                    <span class="nav-label">订单管理</span>
                </div>
                <div class="nav-item" onclick="switchPage('users')">
                    <span class="nav-icon">👥</span>
                    <span class="nav-label">用户管理</span>
                </div>
                <div class="nav-item" onclick="switchPage('logs')">
                    <span class="nav-icon">📋</span>
                    <span class="nav-label">访问日志</span>
                </div>
                <div class="nav-item" onclick="switchPage('config')">
                    <span class="nav-icon">⚙️</span>
                    <span class="nav-label">系统配置</span>
                </div>
                <div class="nav-item" onclick="switchPage('presets')">
                    <span class="nav-icon">📝</span>
                    <span class="nav-label">预设文案</span>
                </div>
            </nav>
            <div class="admin-user">
                <div class="user-info">
                    <div class="user-avatar">👨‍💼</div>
                    <div class="user-details">
                        <div class="user-name" id="adminName">管理员</div>
                        <div class="user-role">系统管理员</div>
                    </div>
                </div>
                <button class="btn-logout" onclick="handleLogout()">退出</button>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="admin-main">
            <!-- 数据概览页 -->
            <div class="admin-page" id="page-dashboard">
                <div class="page-header">
                    <h1>数据概览</h1>
                    <button class="btn-refresh" onclick="loadDashboard()">🔄 刷新</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #3b82f6;">👥</div>
                        <div class="stat-content">
                            <div class="stat-label">总用户数</div>
                            <div class="stat-value" id="stat-users">-</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #10b981;">📦</div>
                        <div class="stat-content">
                            <div class="stat-label">总订单数</div>
                            <div class="stat-value" id="stat-orders">-</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #f59e0b;">💰</div>
                        <div class="stat-content">
                            <div class="stat-label">总收入</div>
                            <div class="stat-value" id="stat-revenue">-</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #8b5cf6;">📊</div>
                        <div class="stat-content">
                            <div class="stat-label">今日订单</div>
                            <div class="stat-value" id="stat-today">-</div>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-card">
                        <h3>订单状态分布</h3>
                        <div id="order-status-chart"></div>
                    </div>
                    <div class="chart-card">
                        <h3>业务类型分布</h3>
                        <div id="order-type-chart"></div>
                    </div>
                </div>
            </div>

            <!-- 订单管理页 -->
            <div class="admin-page" id="page-orders" style="display: none;">
                <div class="page-header">
                    <h1>订单管理</h1>
                    <div class="header-actions">
                        <select id="filter-status" onchange="loadOrders()">
                            <option value="">全部状态</option>
                            <option value="pending">待处理</option>
                            <option value="processing">处理中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">已失败</option>
                        </select>
                        <select id="filter-type" onchange="loadOrders()">
                            <option value="">全部类型</option>
                            <option value="sms">短信</option>
                            <option value="call">电话</option>
                            <option value="human">人工</option>
                        </select>
                        <button class="btn-refresh" onclick="loadOrders()">🔄 刷新</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>订单ID</th>
                                <th>用户</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>金额</th>
                                <th>联系方式</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="orders-tbody">
                            <tr><td colspan="8" style="text-align:center; padding: 40px;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="orders-pagination"></div>
            </div>

            <!-- 用户管理页 -->
            <div class="admin-page" id="page-users" style="display: none;">
                <div class="page-header">
                    <h1>用户管理</h1>
                    <div class="header-actions">
                        <input type="text" id="search-user" placeholder="搜索手机号或昵称" onkeyup="handleSearchUser(event)">
                        <button class="btn-refresh" onclick="loadUsers()">🔄 刷新</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>用户ID</th>
                                <th>手机号</th>
                                <th>昵称</th>
                                <th>余额</th>
                                <th>角色</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr><td colspan="7" style="text-align:center; padding: 40px;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="users-pagination"></div>
            </div>

            <!-- 访问日志页 -->
            <div class="admin-page" id="page-logs" style="display: none;">
                <div class="page-header">
                    <h1>访问日志</h1>
                </div>

                <div class="filter-section">
                    <div class="filter-group">
                        <label>时间范围（天）</label>
                        <select id="filter-days" onchange="loadLogs(1)">
                            <option value="7">最近7天</option>
                            <option value="30">最近30天</option>
                            <option value="90">最近90天</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>管理员</label>
                        <select id="filter-admin" onchange="loadLogs(1)">
                            <option value="">全部管理员</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="loadLogs(1)">🔍 搜索</button>
                    <button class="btn-secondary" onclick="exportLogs()">📥 导出日志</button>
                    <button class="btn-secondary" onclick="cleanupLogs()">🗑️ 清理旧日志</button>
                </div>

                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-label">总访问次数</div>
                        <div class="stat-value" id="stat-total-access">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">活跃管理员</div>
                        <div class="stat-value" id="stat-active-admins">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">最高访问端点</div>
                        <div class="stat-value" id="stat-top-endpoint">-</div>
                    </div>
                </div>

                <div class="table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>管理员</th>
                                <th>手机号</th>
                                <th>操作</th>
                                <th>方法</th>
                                <th>状态</th>
                                <th>IP地址</th>
                            </tr>
                        </thead>
                        <tbody id="logs-tbody">
                            <tr><td colspan="7" style="text-align:center; padding: 20px;">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="pagination" id="logs-pagination"></div>
            </div>

            <!-- 系统配置页 -->
            <div class="admin-page" id="page-config" style="display: none;">
                <div class="page-header">
                    <h1>系统配置</h1>
                </div>
                
                <div class="config-section">
                    <h3>价格配置</h3>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>短信价格（元/条）</label>
                            <input type="number" id="price-sms" step="0.01" value="2.99">
                        </div>
                        <div class="config-item">
                            <label>电话价格（元/次）</label>
                            <input type="number" id="price-call" step="0.01" value="19.00">
                        </div>
                        <div class="config-item">
                            <label>人工传话（元/次）</label>
                            <input type="number" id="price-human" step="0.01" value="29.00">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="savePrices()">💾 保存价格配置</button>
                    <p class="config-note">⚠️ 修改价格后需要手动编辑  文件并重启服务器</p>
                </div>
            </div>

            <!-- 预设文案管理页 -->
            <div class="admin-page" id="page-presets" style="display: none;">
                <div class="page-header">
                    <h1>预设文案管理</h1>
                </div>
                
                <div class="preset-filters">
                    <select id="preset-type-filter" onchange="loadPresets()" style="display: none;">
                        <option value="sms">短信文案</option>
                    </select>
                    <select id="preset-category-filter" onchange="loadPresets()">
                        <option value="">全部分类</option>
                        <option value="复合">复合</option>
                        <option value="告别">告别</option>
                        <option value="表白">表白</option>
                        <option value="祝福">祝福</option>
                    </select>
                    <button class="btn-secondary" onclick="showAddCategoryModal()">➕ 新增分类</button>
                    <button class="btn-primary" onclick="showAddPresetModal()">➕ 添加文案</button>
                </div>

                <div class="presets-container">
                    <div id="presets-grid" class="presets-grid">
                        <!-- 文案卡片将动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div class="modal" id="order-modal">
        <div class="modal-overlay" onclick="closeOrderModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>订单详情</h3>
                <button class="modal-close" onclick="closeOrderModal()">✕</button>
            </div>
            <div class="modal-body" id="order-modal-body"></div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeOrderModal()">关闭</button>
            </div>
        </div>
    </div>

    <!-- 添加/编辑文案模态框 -->
    <div class="modal" id="preset-modal" style="display: none;">
        <div class="modal-overlay" onclick="closePresetModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="preset-modal-title">添加文案</h3>
                <button class="modal-close" onclick="closePresetModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="display: none;">
                    <label>文案类型</label>
                    <select id="preset-type">
                        <option value="sms">短信</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <select id="preset-category">
                        <option value="复合">复合</option>
                        <option value="告别">告别</option>
                        <option value="表白">表白</option>
                        <option value="祝福">祝福</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>内容</label>
                    <textarea id="preset-content" placeholder="请输入文案内容" rows="6" maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closePresetModal()">取消</button>
                <button class="btn-primary" onclick="savePreset()">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加分类模态框 -->
    <div class="modal" id="category-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeCategoryModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加新分类</h3>
                <button class="modal-close" onclick="closeCategoryModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>分类名称</label>
                    <input type="text" id="new-category-name" placeholder="请输入分类名称" maxlength="20">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeCategoryModal()">取消</button>
                <button class="btn-primary" onclick="addCategory()">添加</button>
            </div>
        </div>
    </div>


    <script src="../js/common.js"></script>
    <script>
        // 权限检查 - 只允许管理员访问
        (async function checkAdminAccess() {
            // 检查是否有 token
            if (!hasToken()) {
                window.location.href = './404.html';
                return;
            }

            // 刷新用户信息以获取最新角色
            const userInfo = await refreshUserInfo();
            
            // 检查是否是管理员
            if (!userInfo || !isAdmin()) {
                window.location.href = './404.html';
                return;
            }
        })();
    </script>
    <script src="../js/admin.js"></script>
</body>
</html>
